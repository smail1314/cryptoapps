<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- Prevent zooming -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŠ å¯†æœªä¾†æ–°æ‰‹æ‘èˆ‡æ¨¡æ“¬äº¤æ˜“</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Base slate-900 */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; 
            overscroll-behavior-y: none; /* Prevent bounce effect */
        }
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #1e293b;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 2px;
        }
        /* Neon Text Effect */
        .neon-text {
            text-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
        }
        /* Glass Card Effect */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        /* Toast Animation */
        @keyframes slide-in {
            from { transform: translateY(-100%) translateX(-50%); opacity: 0; }
            to { transform: translateY(0) translateX(-50%); opacity: 1; }
        }
        .toast-enter {
            animation: slide-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        
        /* Pulse Animation for Slider Active State */
        @keyframes pulse-ring {
            0% { transform: translate(-50%, -50%) scale(0.8); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        .slider-active-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid #22d3ee;
            animation: pulse-ring 1s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            pointer-events: none;
        }

        /* Price Pulse Animation */
        @keyframes pulse-green {
            0% { text-shadow: 0 0 0 rgba(74, 222, 128, 0); }
            50% { text-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
            100% { text-shadow: 0 0 0 rgba(74, 222, 128, 0); }
        }
        @keyframes pulse-red {
            0% { text-shadow: 0 0 0 rgba(248, 113, 113, 0); }
            50% { text-shadow: 0 0 10px rgba(248, 113, 113, 0.5); }
            100% { text-shadow: 0 0 0 rgba(248, 113, 113, 0); }
        }
        .pulse-up { animation: pulse-green 0.5s ease-in-out; }
        .pulse-down { animation: pulse-red 0.5s ease-in-out; }

        /* Safe area padding */
        .pb-safe-extended {
            padding-bottom: max(24px, env(safe-area-inset-bottom));
        }
    </style>
</head>
<body class="h-screen w-full overflow-hidden text-slate-100 bg-slate-900 selection:bg-cyan-500/30">
    <div id="app" class="h-full flex flex-col w-full shadow-2xl overflow-hidden relative">
        <!-- Main Content -->
    </div>

    <script>
        // --- Constants ---
        // Added 'stability' factor: Higher means less random noise/wicks (BTC/ETH), Lower means more chaos (DOGE)
        const COINS = [
            { id: 'BTC', name: 'Bitcoin', price: 98000, volatility: 0.0008, stability: 0.8, color: 'orange' },
            { id: 'ETH', name: 'Ethereum', price: 3800, volatility: 0.0012, stability: 0.7, color: 'cyan' },
            { id: 'SOL', name: 'Solana', price: 145, volatility: 0.0025, stability: 0.5, color: 'purple' },
            { id: 'DOGE', name: 'Dogecoin', price: 0.15, volatility: 0.004, stability: 0.3, color: 'yellow' }
        ];
        const LEVERAGE_OPTIONS = [1, 2, 5, 10, 20, 50, 100];
        const MARGIN_PERCENT_OPTIONS = [0.1, 0.25, 0.5, 1.0]; 

        // --- State ---
        const appState = {
            activeTab: 'learn',
            toastMsg: null,
            game: {
                selectedCoin: COINS[0],
                currentPrice: COINS[0].price,
                candles: [],
                balance: 1000, // <--- ä¿®æ”¹ 1ï¼šåˆå§‹æœ¬é‡‘æ”¹ç‚º 1000 å–µï¼
                leverage: 10, 
                marginPercent: 0.1, 
                position: null, 
                lastPriceDirection: null,
                intervalId: null,
                isInitialized: false,
                // Enhanced Market Logic State
                marketState: {
                    phase: 'normal',       // 'normal', 'fakeout', 'rally'
                    eventDirection: 0,     // 1 (Up) or -1 (Down)
                    eventTimer: 0,         // Countdown for current phase
                    targetPrice: null,     // Magnet price for oscillation
                    momentum: 0,           // Current price velocity
                    volatilityMult: 1,     // Dynamic volatility multiplier
                    // æ–°å¢ï¼šå¾®è¶¨å‹¢æ§åˆ¶è®Šæ•¸ï¼Œå‰µé€ å¯†é›†éœ‡ç›ª
                    microTrendDir: 0,       
                    microTrendTimer: 0
                }
            },
        };

        const APP_ROOT = document.getElementById('app');
        let canvasRef = null;

        // --- Icons ---
        function Icon(name, size = 24, className = "") {
            const icons = {
                Coins: `<path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>`,
                Link: `<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>`,
                Bitcoin: `<path d="M10.42 16.61a5.45 5.45 0 0 1-3.72-3.84M13.59 7.39a5.45 5.45 0 0 1 3.72 3.84M22 12A10 10 0 0 1 12 2a10 10 0 0 0 0 20 10 10 0 0 1 0-20m-5.91 3.24a4.4 4.4 0 0 0-7.51 0m.76-1.57h.03m1.45-3.08a4.4 4.4 0 0 0 4.31-4.4a.17.17 0 0 0-.17-.17H9.28a.17.17 0 0 0-.17.17 4.4 4.4 0 0 0 4.31 4.4z"/>`,
                ShieldAlert: `<path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="M12 8v4"/><path d="M12 16h.01"/>`,
                Info: `<circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>`,
                BookOpen: `<path d="M2 19.5c0 .5.5 2 2 2h16c1.5 0 2-1.5 2-2M2 19.5c0-1.5 2-2 2-2h16c0 0 2 .5 2 2M6 21v-1.5M10 21v-1.5M14 21v-1.5M18 21v-1.5"/>`,
                Gamepad2: `<path d="M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6M6 15h3m6 0h3m-9-3v3m0 3v3M12 2v20m9-9h-3m-3-6h3m0 6v3m0 3v3m-3-9V6m-6 3h-3m3 0V6"/>`, // Simplified gamepad
                Box: `<rect width="20" height="20" x="2" y="2" rx="4"/><path d="M8 12h8"/><path d="M12 8v8"/>`,
                Users: `<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>`,
                FileText: `<path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9h5"/><path d="M10 13h5"/><path d="M10 17h3"/>`,
                Gift: `<rect x="3" y="8" width="18" height="13" rx="2"/><path d="M12 8V3H6a2 2 0 0 1-2-2v5"/><path d="M12 8V3h6a2 2 0 0 0 2-2v5"/>`,
                AlertTriangle: `<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>`,
                Globe: `<circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/>`,
                Check: `<polyline points="20 6 9 17 4 12"/>`,
                X: `<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>`,
                Lock: `<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>`,
                Unlock: `<rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path>`
            };
            
            if(name === 'Gamepad2') {
                 return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}"><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/><rect x="2" y="6" width="20" height="12" rx="2"/></svg>`;
            }
            return `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${icons[name] || ''}</svg>`;
        }

        // --- Helper Functions ---
        function createElement(tag, classes, content, attributes = {}) {
            const el = document.createElement(tag);
            if (classes) el.className = classes;
            if (content) el.innerHTML = content;
            Object.keys(attributes).forEach(key => {
                if (key === 'disabled') el.disabled = !!attributes[key];
                else if (key === 'value') el.value = attributes[key];
                else el.setAttribute(key, attributes[key]);
            });
            return el;
        }

        function setState(newState) {
            const tabChanged = newState.activeTab && newState.activeTab !== appState.activeTab;
            let scrollPosition = 0;
            const scrollableElement = document.querySelector('.custom-scroll'); 
            if (scrollableElement && appState.activeTab !== 'game' && !tabChanged) {
                 scrollPosition = scrollableElement.scrollTop;
            }
            Object.assign(appState, newState);
            renderApp();
            setTimeout(() => {
                const newScrollableElement = document.querySelector('.custom-scroll');
                if (newScrollableElement && !tabChanged) newScrollableElement.scrollTop = scrollPosition;
            }, 0);
        }

        function setNestedState(parentKey, newNestedState) {
            let scrollPosition = 0;
            const scrollableElement = document.querySelector('.custom-scroll');
            if (scrollableElement && appState.activeTab !== 'game') {
                 scrollPosition = scrollableElement.scrollTop;
            }
            Object.assign(appState[parentKey], newNestedState);
            renderApp();
            setTimeout(() => {
                const newScrollableElement = document.querySelector('.custom-scroll');
                if (newScrollableElement && appState.activeTab !== 'game') newScrollableElement.scrollTop = scrollPosition;
            }, 0);
        }

        function showToast(msg) {
            const existingToast = document.getElementById('toast');
            if (existingToast) existingToast.remove();

            setState({ toastMsg: null });
            setTimeout(() => {
                setState({ toastMsg: msg });
                setTimeout(() => setState({ toastMsg: null }), 3000);
            }, 10);
        }

        function getPricePrecision(coinId) {
            return coinId === 'DOGE' ? 5 : 2;
        }

        // --- DRAG LOGIC ---
        function makeDraggable(element, container) {
            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            const onStart = (e) => {
                // Determine start position
                if (e.type === 'touchstart') {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                } else {
                    startX = e.clientX;
                    startY = e.clientY;
                }

                initialLeft = element.offsetLeft;
                initialTop = element.offsetTop;

                isDragging = true;
                element.style.cursor = 'grabbing';
                
                // Add window listeners for movement outside element
                if (e.type === 'touchstart') {
                    window.addEventListener('touchmove', onMove, { passive: false });
                    window.addEventListener('touchend', onEnd);
                } else {
                    window.addEventListener('mousemove', onMove);
                    window.addEventListener('mouseup', onEnd);
                }
            };

            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault(); // Stop scrolling while dragging

                let currentX, currentY;
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }

                const dx = currentX - startX;
                const dy = currentY - startY;

                let newLeft = initialLeft + dx;
                let newTop = initialTop + dy;

                // Boundary constraints
                const containerRect = container.getBoundingClientRect();
                const elemRect = element.getBoundingClientRect();
                const minLeft = 0;
                const maxLeft = containerRect.width - elemRect.width;
                const minTop = 0;
                const maxTop = containerRect.height - elemRect.height;

                newLeft = Math.max(minLeft, Math.min(newLeft, maxLeft));
                newTop = Math.max(minTop, Math.min(newTop, maxTop));

                element.style.left = `${newLeft}px`;
                element.style.top = `${newTop}px`;
                element.style.right = 'auto';
                element.style.bottom = 'auto';
            };

            const onEnd = () => {
                isDragging = false;
                element.style.cursor = 'grab';
                window.removeEventListener('touchmove', onMove);
                window.removeEventListener('touchend', onEnd);
                window.removeEventListener('mousemove', onMove);
                window.removeEventListener('mouseup', onEnd);
            };

            element.style.cursor = 'grab';
            element.addEventListener('mousedown', onStart);
            element.addEventListener('touchstart', onStart, { passive: false });
        }


        // --- Logic ---
        function calculateFloatingPnL() {
            const { position, currentPrice } = appState.game;
            if (!position) return 0;
            if (position.type === 'long') {
                return (currentPrice / position.entryPrice - 1) * position.size; 
            }
            return (1 - currentPrice / position.entryPrice) * position.size;
        }

        function closePosition() {
            const { position, currentPrice } = appState.game;
            if (!position) return;
            const pnl = calculateFloatingPnL();
            const newBalance = appState.game.balance + position.margin + pnl;
            const isProfit = pnl > 0;
            showToast(`å¹³å€‰æˆåŠŸï¼ ${isProfit ? 'ç²åˆ©' : 'è™§æ'} ${Math.abs(pnl).toFixed(2)} USDT å–µï¼`);
            setNestedState('game', {
                balance: Math.max(0, newBalance),
                position: null
            });
        }

        function liquidatePosition() {
            showToast(`âš ï¸ çˆ†å€‰äº†ï¼ä½ çš„å€‰ä½å·²è¢«å¼·åˆ¶å¹³å€‰å–µ ğŸ’¸`);
            setNestedState('game', { position: null });
        }

        function handleTrade(type) {
            const { game } = appState;
            if (game.position) {
                showToast("è«‹å…ˆå¹³å€‰å†é–‹æ–°å–®å–µï¼");
                return;
            }
            const margin = game.balance * game.marginPercent; 
            if (margin < 10) {
                showToast("é¤˜é¡ä¸è¶³ä»¥æ”¯ä»˜æœ€ä½ä¿è­‰é‡‘ (10 USDT) å–µï¼");
                return;
            }
            const leverage = game.leverage; 
            const positionSize = margin * leverage;
            let liqPrice;
            
            if (type === 'long') liqPrice = game.currentPrice * (1 - (0.8 / leverage)); 
            else liqPrice = game.currentPrice * (1 + (0.8 / leverage));

            setNestedState('game', {
                position: { type, entryPrice: game.currentPrice, margin, size: positionSize, coin: game.selectedCoin.id, leverage, liqPrice },
                balance: game.balance - margin
            });
            showToast(`${type === 'long' ? 'åšå¤š' : 'åšç©º'} é–‹å–®æˆåŠŸå–µï¼`);
        }

        // --- render functions ---
        function renderToast() {
            if (!appState.toastMsg) return '';
            return `
                <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] toast-enter w-11/12 max-w-sm pointer-events-none">
                    <div class="bg-slate-800/90 border border-cyan-500/50 text-cyan-100 px-4 py-3 rounded-2xl shadow-2xl flex items-center gap-3 backdrop-blur-md">
                        ${Icon('Info', 20, 'text-cyan-400 shrink-0')}
                        <span class="text-sm font-medium leading-tight">${appState.toastMsg}</span>
                    </div>
                </div>
            `;
        }

        function renderLearnView() {
            const view = createElement('div', 'h-full overflow-y-auto pb-48 custom-scroll bg-slate-900');
            
            const hero = `
                <div class="relative pt-4 pb-6 px-6 border-b border-slate-800 bg-gradient-to-b from-slate-900 via-slate-800 to-slate-900 overflow-hidden">
                    <div class="absolute top-0 right-0 opacity-20 pointer-events-none">
                        <div class="w-48 h-48 bg-cyan-500 rounded-full blur-[60px] -translate-y-1/2 translate-x-1/2"></div>
                    </div>
                    <div class="relative z-10 text-center">
                        <h1 class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-500 mb-2 neon-text tracking-tight pt-2">åŠ å¯†æœªä¾†</h1>
                        <p class="text-slate-400 text-sm mb-4 font-medium tracking-wide">å°ç£æ•¸ä½è³‡ç”¢æ”¿ç­–èˆ‡æŒ‘æˆ°ç ”ç©¶</p>
                        <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-slate-800/80 border border-slate-700 text-xs text-slate-300 backdrop-blur-sm shadow-sm">
                            <span class="font-semibold text-cyan-400">ç¬¬äº”çµ„</span>
                            <span class="w-1 h-1 rounded-full bg-slate-500"></span>
                            <span>å°ˆé¡Œç²¾è¯</span>
                        </div>
                    </div>
                </div>
            `;

            const createSection = (title, icon, items) => {
                const itemsHtml = items.map(item => `
                    <div class="glass-card rounded-2xl p-5 mb-4 hover:border-cyan-500/40 transition-all duration-300 group">
                        <h3 class="text-cyan-400 font-bold text-lg mb-3 flex items-center gap-2 group-hover:text-cyan-300 transition-colors">
                            ${item.icon || 'ğŸ”¹'} ${item.title}
                        </h3>
                        <div class="text-slate-300 text-sm leading-relaxed text-justify opacity-90">
                            ${item.content}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="mb-8">
                        <h2 class="text-xl font-bold text-white flex items-center gap-2 mb-4 px-2">
                            ${icon} ${title}
                        </h2>
                        <div>${itemsHtml}</div>
                    </div>
                `;
            };

            const concepts = [
                {
                    title: "ç†å¿µï¼šæŠŠã€ŒéŒ¢çš„æ§åˆ¶æ¬Šã€é‚„çµ¦ä½ ",
                    icon: "ğŸ—½",
                    content: "<p class='mb-2'><strong>æ ¸å¿ƒç²¾ç¥ï¼š</strong>æ¯”ç‰¹å¹£ç™¼æ˜è€…ä¸­æœ¬è°çš„æƒ³æ³•â€”â€”<strong>ã€Œå¦‚æœæˆ‘å€‘ä¸éœ€è¦éŠ€è¡Œï¼Œå°±èƒ½ç›´æ¥é»å°é» (P2P) è½‰å¸³å‘¢ï¼Ÿã€</strong></p><p>é€™å°±æ˜¯ã€Œå»ä¸­å¿ƒåŒ–ã€çš„åˆè¡·ï¼šæ²’æœ‰å¤§å°ã€æ²’æœ‰å¯©æŸ¥ï¼Œä½ çš„è³‡ç”¢çœŸæ­£å±¬æ–¼ä½ å–µã€‚</p>"
                },
                {
                    title: "ç‚ºä»€éº¼ä¸èƒ½è¢«å½é€ ï¼Ÿ",
                    icon: "ğŸ›¡ï¸",
                    content: "<p class='mb-2'><strong>åˆ†æ•£å¼å¸³æœ¬æŠ€è¡“ï¼š</strong>æƒ³åƒå…¨ç­åŒå­¸éƒ½æœ‰ä¸€æœ¬ä¸€æ¨¡ä¸€æ¨£çš„å¸³ç°¿ã€‚æ¯ç•¶æœ‰äººäº¤æ˜“ï¼Œå…¨ç­åŒæ­¥è¨˜å¸³ã€‚</p><p>å¦‚æœæœ‰äººæƒ³å·æ”¹è‡ªå·±çš„é¤˜é¡ï¼Œæœƒç«‹åˆ»è¢«å…¶ä»–å¹¾åƒå¹¾è¬æœ¬å¸³ç°¿æŠ“åŒ…å–µï¼</p>"
                },
                {
                    title: "ç‚ºä»€éº¼æœ‰åƒ¹å€¼ï¼Ÿ",
                    icon: "ğŸ’",
                    content: "<p><strong>æ•¸ä½ç¨€ç¼ºæ€§ï¼š</strong>é€éç¨‹å¼ç¢¼é™åˆ¶ï¼Œæ¯”ç‰¹å¹£ç¸½é‡åªæœ‰ <strong>2,100 è¬é¡†</strong>ï¼Œæ°¸é ç„¡æ³•è¶…ç™¼ã€‚</p><p>é€™ç¨®é™é‡ç™¼è¡Œçš„ç‰¹æ€§ï¼Œè®“å®ƒåƒæ•¸ä½é»ƒé‡‘ä¸€æ¨£ï¼Œèƒ½å¤ å°æŠ—é€šè²¨è†¨è„¹ã€‚</p>"
                },
                {
                    title: "èª°ä¾†ç¶­æŒé‹ä½œï¼Ÿ",
                    icon: "ğŸ¤",
                    content: "<p><strong>ç¤¦å·¥èˆ‡é©—è­‰è€…ï¼š</strong>æ—¢ç„¶æ²’æœ‰éŠ€è¡Œå“¡å·¥ï¼Œèª°ä¾†å¹«å¿™è¨˜å¸³ï¼Ÿ</p><p>ç­”æ¡ˆæ˜¯è²¢ç»é›»è…¦ç®—åŠ›çš„ç¤¦å·¥ï¼Œç³»çµ±æœƒè‡ªå‹•ç™¼é€åŠ å¯†è²¨å¹£ä½œç‚ºçå‹µï¼Œé€™æ˜¯ä¸€å€‹è¨­è¨ˆç²¾å¦™çš„ç¶“æ¿Ÿèª˜å› ç³»çµ±å–µã€‚</p>"
                }
            ];

            const faq = [
                {
                    title: "è²·è³£åŠ å¯†è²¨å¹£ã€Œåˆæ³•ã€å—ï¼Ÿ",
                    icon: "âš–ï¸",
                    content: "<p><strong>åˆæ³•ï¼Œä½†å—ç›£ç®¡ã€‚</strong></p><p>å°ç£ç›®å‰ä¸¦ä¸ç¦æ­¢ï¼Œä½†æ”¿åºœè¦æ±‚äº¤æ˜“æ‰€å¿…é ˆé€šéæ´—éŒ¢é˜²åˆ¶è²æ˜ã€‚åªè¦é¸å°ç£åˆè¦çš„äº¤æ˜“æ‰€ï¼ˆå¦‚ MaiCoin, BitoPro ç­‰ï¼‰ï¼Œå°±æ˜¯åˆæ³•çš„å–µã€‚</p>"
                },
                {
                    title: "è²·ä¸èµ·ä¸€é¡†æ¯”ç‰¹å¹£æ€éº¼è¾¦ï¼Ÿ",
                    icon: "ğŸ’°",
                    content: "<p><strong>ä¸ç”¨è²·æ•´é¡†ï¼å¯ä»¥åªè²· 100 å°å¹£ã€‚</strong></p><p>åŠ å¯†è²¨å¹£å¯ä»¥åˆ†å‰²åˆ°å°æ•¸é»å¾Œ 8 ä½ã€‚å°±åƒé»ƒé‡‘å¯ä»¥è²· 1 å…‹ï¼Œä½ ä¹Ÿå¯ä»¥åªè²· 0.0001 é¡†ï¼Œé©åˆå®šæœŸå®šé¡æŠ•è³‡ã€‚</p>"
                },
                {
                    title: "è³ºéŒ¢éœ€è¦ç¹³ç¨…å—ï¼Ÿ",
                    icon: "ğŸ’¸",
                    content: "<p><strong>å€‹äººå°é¡é€šå¸¸ä¸ç”¨ï¼Œå¤§æˆ¶è¦æ³¨æ„ã€‚</strong></p><p>ç›®å‰å°ç£å€‹äººè²·è³£è‹¥è¢«è¦–ç‚ºæµ·å¤–æ‰€å¾—ï¼Œæœ‰ 750 è¬å°å¹£çš„å…ç¨…é¡åº¦ã€‚ä½†è‹¥åœ¨åœ‹å…§äº¤æ˜“æ‰€å‡ºé‡‘é »ç¹æˆ–é‡‘é¡éå¤§ï¼Œåœ‹ç¨…å±€å¯èƒ½æœƒé—œåˆ‡å–µã€‚</p>"
                },
                {
                    title: "å¾ˆæ€•è¢«è©é¨™ï¼Œæ€éº¼é é˜²ï¼Ÿ",
                    icon: "ğŸš¨",
                    content: "<ul class='list-disc pl-4 space-y-1'><li><strong>ä¸ä»£æ“ï¼š</strong>èªªã€Œä¿è­‰ç²åˆ©ã€ã€ã€Œè€å¸«å¸¶å–®ã€çš„éƒ½æ˜¯è©é¨™ã€‚</li><li><strong>åªç”¨å¤§å¹³å°ï¼š</strong>ä¸è¦ä¸‹è¼‰ç¶²å‹å‚³çµ¦ä½ çš„å¥‡æ€ª Appã€‚</li><li><strong>é¡§å¥½ç§é‘°ï¼š</strong>åŠ©è¨˜è©çµ•ä¸çµ¦äººï¼Œçµ¦äº†éŒ¢å°±æ²’äº†ã€‚</li></ul>"
                }
            ];

            view.innerHTML = hero + 
                             `<div class="p-5 max-w-2xl mx-auto">
                                ${createSection("æ ¸å¿ƒè§€å¿µ", Icon('Globe', 24, 'text-blue-400'), concepts)}
                                <div class="h-px bg-slate-800 my-6"></div>
                                ${createSection("å°ç£äººæœ€æƒ³å•çš„ FAQ", Icon('Info', 24, 'text-green-400'), faq)}
                                <div class="mt-10 text-center text-xs text-slate-500 pb-6 border-t border-slate-800 pt-6">
                                    <p class="mb-2 font-medium text-slate-400">è³‡æ–™ä¾†æºï¼šåŠ å¯†æœªä¾†å°ˆé¡Œç ”ç©¶ç¶²ç«™</p>
                                    <p class="opacity-60">å…è²¬è²æ˜ï¼šæœ¬å…§å®¹åƒ…ä¾›æ•™å­¸ï¼Œä¸æ§‹æˆæŠ•è³‡å»ºè­°å–µã€‚</p>
                                </div>
                              </div>`;
            return view;
        }

        function renderAboutView() {
            const view = createElement('div', 'h-full overflow-y-auto p-6 pb-48 custom-scroll bg-slate-900');
            view.innerHTML = `
                <div class="text-center mb-10 mt-2">
                    <div class="w-28 h-28 rounded-full mx-auto flex items-center justify-center mb-5 shadow-xl shadow-cyan-500/20 border-4 border-slate-800 bg-slate-800 overflow-hidden relative group">
                        <div class="absolute inset-0 bg-cyan-500/10 group-hover:bg-cyan-500/0 transition-colors"></div>
                        <img src="https://i.meee.com.tw/m4p5cTa.png" alt="åŠ å¯†æœªä¾† Logo" class="w-full h-full object-cover scale-105" style="transform: translateX(-3px);">
                    </div>
                    <h2 class="text-3xl font-bold text-white mb-1">åŠ å¯†æœªä¾†</h2>
                    <p class="text-cyan-400 text-sm font-medium tracking-wide">å°ç£æ•¸ä½è³‡ç”¢æ”¿ç­–èˆ‡æŒ‘æˆ°ç ”ç©¶</p>
                </div>
                <div class="space-y-5 max-w-md mx-auto">
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-slate-700 backdrop-blur-sm">
                        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                            ${Icon('Users', 20, 'text-purple-400')} ç ”ç©¶åœ˜éšŠ (è™•ä¸‰å­)
                        </h3>
                        <div class="grid grid-cols-2 gap-y-3 gap-x-4 text-sm text-slate-300 font-medium">
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>ä¸èŠ·å®œ</div>
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>éƒ­æ¹˜å®œ</div>
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>é»ƒåŸ¹æ©</div>
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>é™³æŸç¿°</div>
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>è¨±ç§ç‘‹</div>
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>è‘‰å®¥æˆ</div>
                            <div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-purple-500"></div>é›·é–”ç¿°</div>
                        </div>
                        <div class="mt-5 pt-4 border-t border-slate-700/50 flex justify-between text-xs text-slate-500">
                            <span>å­¸å¹´åº¦ï¼š114</span>
                            <span>çµ„åˆ¥ï¼šç¬¬äº”çµ„</span>
                        </div>
                    </div>
                    <div class="bg-slate-800/50 rounded-2xl p-6 border border-slate-700 backdrop-blur-sm">
                        <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                            ${Icon('FileText', 20, 'text-cyan-400')} ç ”ç©¶å®—æ—¨
                        </h3>
                        <p class="text-sm text-slate-300 leading-relaxed text-justify">
                            å¾è¯çˆ¾è¡—åˆ°çŸ½è°·éƒ½åœ¨æ¶é€²çš„åŠ å¯†æµªæ½®ä¸‹ï¼Œæ¢è¨å°ç£çš„ä¸‹ä¸€æ­¥ï¼Œæ˜¯æˆç‚ºäºæ´²çš„åŠ å¯†æ¨ç´ï¼Œé‚„æ˜¯è¢«é‚Šç·£åŒ–çš„å­¤å³¶ï¼Ÿæˆ‘å€‘è‡´åŠ›æ–¼è®“å¤§çœ¾ç†è§£é€™å ´æ­£åœ¨ç™¼ç”Ÿçš„é‡‘èé©å‘½å–µã€‚
                        </p>
                    </div>
                    <a href="https://www.ourbit.com/zh-TW/register?inviteCode=4XWPUX" target="_blank" rel="noopener noreferrer" class="block w-full bg-gradient-to-r from-amber-500 to-orange-600 p-4 rounded-2xl text-center shadow-lg shadow-orange-900/20 active:scale-95 transition-all hover:brightness-110">
                        <p class="text-white font-bold text-lg flex items-center justify-center gap-2">${Icon('Gift', 20)} å‰å¾€äº¤æ˜“æ‰€è¨»å†Š</p>
                        <p class="text-white/80 text-xs mt-1 font-medium">å¦‚æœä½ å°çœŸå¯¦äº¤æ˜“æœ‰èˆˆè¶£ (å¤–éƒ¨é€£çµ)</p>
                    </a>
                </div>`;
            return view;
        }

        // --- ENHANCED GAME LOGIC ---
        function runGameLoop() {
            const { game } = appState;
            const ms = game.marketState;
            const coin = game.selectedCoin;
            
            // --- 1. Event State Machine ---
            if (ms.eventTimer > 0) {
                ms.eventTimer--;
            }

            // State Transitions
            if (ms.phase === 'normal') {
                // In normal phase:
                // 1. Oscillation around a moving baseline
                // 2. Small random "traps" (micro-spikes)
                // 3. Rare chance to trigger a major event (Big Move)
                
                // --- ä¿®æ”¹ 2ï¼šé™ä½å¤§è¡Œæƒ…è§¸ç™¼æ©Ÿç‡ ---
                // å¾ 0.0006 (0.06%) é™åˆ° 0.0001 (0.01%)ï¼Œæ¸›å°‘æš´æ¼²æš´è·Œ
                if (Math.random() < 0.0001 && ms.eventTimer <= 0) {
                    // Initialize Event: "Fakeout" then "Rally/Crash"
                    ms.phase = 'fakeout';
                    ms.eventDirection = Math.random() > 0.5 ? 1 : -1; // 1 = Bullish Event (eventual UP), -1 = Bearish
                    ms.eventTimer = 10 + Math.floor(Math.random() * 10); // Fakeout lasts 5-10 seconds
                    // Set target for the main move (3% to 5%)
                    ms.targetTotalChange = (0.03 + Math.random() * 0.02); 
                    ms.volatilityMult = 1.0;
                    console.log(`[Market] Event Triggered! Direction: ${ms.eventDirection > 0 ? 'UP' : 'DOWN'}`);
                }
            } 
            else if (ms.phase === 'fakeout') {
                // If fakeout timer ends, switch to the main rally/crash
                if (ms.eventTimer <= 0) {
                    ms.phase = 'rally';
                    // Main move lasts longer (15-25 seconds -> 30-50 ticks)
                    ms.eventTimer = 40 + Math.floor(Math.random() * 40); 
                    ms.totalEventDuration = ms.eventTimer; // Store total duration for progress calc
                }
            } 
            else if (ms.phase === 'rally') {
                // End of event
                if (ms.eventTimer <= 0) {
                    ms.phase = 'normal';
                    ms.targetPrice = game.currentPrice; // Reset magnet to new level
                    ms.momentum = 0;
                }
            }

            // --- 2. Price Calculation Logic ---
            
            let changePercent = 0;
            const baseVol = coin.volatility;
            // Stability factor: BTC/ETH have less random noise
            const noise = (Math.random() - 0.5) * baseVol * (1.1 - (coin.stability || 0.5));

            if (ms.phase === 'normal') {
                // --- Normal Mode: Oscillation & Traps ---
                
                // Magnet effect: Pull price towards targetPrice
                if (!ms.targetPrice) ms.targetPrice = game.currentPrice;
                
                // Drift the target price slowly (Brownian motion) so it's not static
                ms.targetPrice *= (1 + (Math.random() - 0.5) * 0.001);
                
                const distToTarget = (ms.targetPrice - game.currentPrice) / game.currentPrice;
                const pull = distToTarget * 0.05; // Elasticity strength
                
                // Micro-Trap: occasional sharp spike
                let trap = 0;
                if (Math.random() < 0.08) { // 8% chance of a "wick" attempt
                   trap = (Math.random() - 0.5) * baseVol * 2.0; 
                }

                // --- ä¿®æ”¹ 3ï¼šå¾®è¶¨å‹¢ (Micro-Trend) é‚è¼¯ ---
                // å‰µé€ å¯†é›†çš„ä¸Šä¸‹éœ‡ç›ªï¼Œè€Œééš¨æ©Ÿæ¼«æ­¥
                if (ms.microTrendTimer <= 0) {
                    // éš¨æ©Ÿæ±ºå®šä¸€å€‹æ–°æ–¹å‘ (1: ä¸Š, -1: ä¸‹)
                    ms.microTrendDir = Math.random() > 0.5 ? 1 : -1;
                    // æŒçºŒæ™‚é–“çŸ­ï¼Œç´„ 2-5 ç§’ (4-10 ticks)
                    ms.microTrendTimer = 4 + Math.floor(Math.random() * 6);
                }
                ms.microTrendTimer--;
                
                // æ–½åŠ å¾®è¶¨å‹¢åŠ›é‡
                const microTrendForce = ms.microTrendDir * (baseVol * 0.4); 

                changePercent = noise + pull + trap + microTrendForce;

            } else if (ms.phase === 'fakeout') {
                // --- Fakeout Mode: Move OPPOSITE to eventDirection ---
                // "Go down before you go up"
                const fakeDir = -1 * ms.eventDirection;
                const steadyDrift = fakeDir * (baseVol * 0.5); // Slow drift opposite way
                changePercent = steadyDrift + (noise * 0.5); // Low noise, suspicious calm

            } else if (ms.phase === 'rally') {
                // --- Rally Mode: Progressive move with SHAKEOUTS ---
                const progress = 1 - (ms.eventTimer / ms.totalEventDuration); // 0 to 1
                
                // Non-linear ease-in-out curve for natural market surge (starts slow, fast mid, slow end)
                const trendSpeed = Math.sin(progress * Math.PI); 
                
                // Calculate step size based on target change
                // We multiply by trendSpeed to concentrate movement in the middle
                const stepMove = (ms.targetTotalChange / ms.totalEventDuration) * ms.eventDirection * 2.5 * trendSpeed;
                
                // High Noise during rally (Jagged lines)
                const rallyNoise = (Math.random() - 0.5) * baseVol * 3.0;
                
                // --- THE ANTI-1729x MECHANISM: SHAKEOUTS ---
                // 10% chance per tick to move violently AGAINST the trend
                // This liquidates high leverage traders holding the "correct" direction
                let shakeout = 0;
                if (Math.random() < 0.1) {
                    // Move opposite to eventDirection
                    shakeout = -1 * ms.eventDirection * (baseVol * 8.0); // Very strong counter-wick
                }
                
                changePercent = stepMove + rallyNoise + shakeout;
            }

            // Apply change
            let newPrice = game.currentPrice * (1 + changePercent);
            newPrice = Math.max(0.000001, newPrice); // Safety floor
            
            const direction = newPrice >= game.currentPrice ? 'up' : 'down';

            // Check Liquidation (Passive check only, does not influence price)
            if (game.position) {
                const isLiq = (game.position.type === 'long' && newPrice <= game.position.liqPrice) ||
                              (game.position.type === 'short' && newPrice >= game.position.liqPrice);
                if (isLiq) liquidatePosition();
            }

            // Update Candles
            let newCandles = [...game.candles];
            // Candle update logic (Time-based aggregation simulation)
            // 15% chance to start new candle (simulating time passing), or force if too few
            // Otherwise update current candle
            if (newCandles.length === 0 || Math.random() > 0.85) { 
                newCandles.push({ open: newPrice, close: newPrice, high: newPrice, low: newPrice });
                if (newCandles.length > 50) newCandles.shift(); 
            } else {
                const cur = newCandles[newCandles.length - 1];
                cur.close = newPrice;
                cur.high = Math.max(cur.high, newPrice);
                cur.low = Math.min(cur.low, newPrice);
            }

            Object.assign(appState.game, {
                currentPrice: newPrice,
                lastPriceDirection: direction,
                candles: newCandles
            });

            if (appState.activeTab === 'game') {
                drawChart();
                updateDashboardDisplay();
            }
        }

        function startGameLoop() {
            if (appState.game.intervalId) clearInterval(appState.game.intervalId);
            appState.game.intervalId = setInterval(runGameLoop, 500);

            if (!appState.game.isInitialized) {
                // Initialize sophisticated history
                const startPrice = appState.game.selectedCoin.price;
                let temp = startPrice;
                const history = [];
                // Generate a bit of "Fake history" that looks realistic
                for(let i=0; i<40; i++) {
                    const open = temp;
                    const change = (Math.random() - 0.5) * appState.game.selectedCoin.volatility * 5;
                    const close = open * (1 + change);
                    history.push({ 
                        open, close, 
                        high: Math.max(open, close) * (1 + Math.random() * 0.001), 
                        low: Math.min(open, close) * (1 - Math.random() * 0.001) 
                    });
                    temp = close;
                }
                
                // Initialize Market State
                const initialMarketState = {
                    phase: 'normal',
                    eventDirection: 0,
                    eventTimer: 0,
                    targetPrice: temp, // Start with current price as target
                    momentum: 0,
                    volatilityMult: 1,
                    microTrendDir: 0,
                    microTrendTimer: 0
                };

                setNestedState('game', { 
                    candles: history, 
                    currentPrice: temp, 
                    isInitialized: true,
                    marketState: initialMarketState
                });
            }
        }

        // --- ROBUST Custom Long-Press Slider Logic ---
        function initLongPressSlider(containerElement, initialValueIndex, options, onUpdate) {
            if(!containerElement) return;

            const thumb = containerElement.querySelector('.thumb');
            const fill = containerElement.querySelector('.fill');
            const sliderLabel = containerElement.closest('.slider-wrapper').querySelector('.slider-label');

            let isDragging = false;
            let isUnlocked = false;
            let longPressTimer = null;
            let currentIndex = initialValueIndex;
            
            const setVisuals = (idx, unlocked) => {
                const percent = (idx / (options.length - 1)) * 100;
                if(thumb) thumb.style.left = `${percent}%`;
                if(fill) fill.style.width = `${percent}%`;
                
                if(thumb) {
                    if (unlocked) {
                        thumb.classList.add('scale-125', 'ring-2', 'ring-cyan-300', 'bg-cyan-300');
                        thumb.classList.remove('bg-cyan-400');
                        if(!thumb.querySelector('.slider-active-ring')) {
                             const ring = document.createElement('div');
                             ring.className = 'slider-active-ring';
                             thumb.appendChild(ring);
                        }
                    } else {
                        thumb.classList.remove('scale-125', 'ring-2', 'ring-cyan-300', 'bg-cyan-300');
                        thumb.classList.add('bg-cyan-400');
                        const ring = thumb.querySelector('.slider-active-ring');
                        if(ring) ring.remove();
                    }
                }

                if(sliderLabel) sliderLabel.textContent = `${options[idx]}x`;
            };

            // Initialize visuals
            setVisuals(currentIndex, false);

            const handleMove = (e) => {
                if (!isDragging) {
                    if (longPressTimer) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                    }
                    return;
                }
                
                // Only prevent default if we are actually dragging
                e.preventDefault(); 

                const rect = containerElement.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                let percent = (clientX - rect.left) / rect.width;
                percent = Math.max(0, Math.min(1, percent));
                
                const rawIndex = percent * (options.length - 1);
                const newIndex = Math.round(rawIndex);
                
                if (newIndex !== currentIndex) {
                    currentIndex = newIndex;
                    setVisuals(currentIndex, true);
                    onUpdate(options[currentIndex]);
                    if(navigator.vibrate) navigator.vibrate(10);
                }
            };

            const handleEnd = () => {
                if (longPressTimer) clearTimeout(longPressTimer);
                isDragging = false;
                isUnlocked = false;
                setVisuals(currentIndex, false);
                
                // Cleanup window listeners
                window.removeEventListener('touchmove', handleMove);
                window.removeEventListener('touchend', handleEnd);
                window.removeEventListener('mousemove', handleMove);
                window.removeEventListener('mouseup', handleEnd);
            };

            const handleStart = (e) => {
                if (e.touches && e.touches.length > 1) return;
                
                // Attach window listeners ONLY when interaction starts
                // Use passive: false for touchmove to allow preventing scroll
                window.addEventListener('touchmove', handleMove, { passive: false });
                window.addEventListener('touchend', handleEnd);
                
                // Mouse fallback
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('mouseup', handleEnd);

                longPressTimer = setTimeout(() => {
                    isUnlocked = true;
                    isDragging = true;
                    setVisuals(currentIndex, true);
                    if(navigator.vibrate) navigator.vibrate(50);
                }, 300); 
            };

            // Attach start listener to the container
            containerElement.addEventListener('touchstart', handleStart, { passive: false });
            containerElement.addEventListener('mousedown', handleStart);
        }

        function updateDashboardDisplay() {
            const { game } = appState;
            const pricePrecision = getPricePrecision(game.selectedCoin.id);
            const floatingPnL = calculateFloatingPnL();
            const totalEquity = (game.balance + (game.position ? floatingPnL : 0) + (game.position ? game.position.margin : 0)).toFixed(2);
            const pnlColorClass = floatingPnL > 0 ? 'text-green-400' : floatingPnL < 0 ? 'text-red-400' : 'text-slate-200';
            const pnlText = game.position ? (floatingPnL > 0 ? '+' : '') + floatingPnL.toFixed(2) : '--';
            const priceColorClass = game.lastPriceDirection === 'up' ? 'text-green-400' : 'text-red-400';

            // Daily Change
            const basePrice = game.selectedCoin.price;
            const dailyChange = ((game.currentPrice - basePrice) / basePrice) * 100;
            const dailyChangeText = (dailyChange >= 0 ? '+' : '') + dailyChange.toFixed(2) + '%';
            const dailyChangeColor = dailyChange >= 0 ? 'text-green-400' : 'text-red-400';

            let roeText = '--';
            let roePercent = 0;
            if (game.position) {
                roePercent = (floatingPnL / game.position.margin) * 100;
                roeText = (roePercent > 0 ? '+' : '') + roePercent.toFixed(2) + '%';
            }

            const els = {
                priceValue: document.getElementById('game-price-value'),
                priceLabel: document.getElementById('game-price-label'),
                priceChange: document.getElementById('game-price-change'),
                balance: document.getElementById('game-balance'),
                equity: document.getElementById('game-equity'),
                pnl: document.getElementById('game-pnl'),
                roe: document.getElementById('game-roe'),
                roeProgress: document.getElementById('game-roe-progress'),
                priceWrapper: document.getElementById('game-price-wrapper')
            };

            if (els.priceValue) {
                if (els.priceWrapper) {
                    const pulseClass = game.lastPriceDirection === 'up' ? 'pulse-up' : 'pulse-down';
                    els.priceValue.className = pulseClass;
                    setTimeout(() => els.priceValue.classList.remove(pulseClass), 500);
                }
                els.priceValue.textContent = game.currentPrice.toFixed(pricePrecision);
                els.priceLabel.className = `text-sm font-sans font-bold ${priceColorClass}`;
            }
            if (els.priceChange) {
                els.priceChange.textContent = dailyChangeText;
                els.priceChange.className = `text-sm font-mono font-bold ml-2 ${dailyChangeColor}`;
            }
            if (els.balance) els.balance.textContent = game.balance.toFixed(2);
            if (els.equity) els.equity.textContent = totalEquity;
            if (els.pnl) {
                els.pnl.textContent = pnlText;
                els.pnl.className = `text-base font-bold ${pnlColorClass}`;
            }
            if (els.roe) {
                els.roe.textContent = roeText;
                els.roe.className = `font-bold ${roePercent > 0 ? 'text-green-400' : roePercent < 0 ? 'text-red-400' : 'text-slate-200'}`;
            }
            if (els.roeProgress) {
                const clampedRoe = Math.max(-100, Math.min(100, roePercent));
                const width = Math.abs(clampedRoe) / 2; 
                if (clampedRoe >= 0) {
                    els.roeProgress.style.left = `${50 - width}%`;
                    els.roeProgress.style.width = `${width}%`;
                    els.roeProgress.style.backgroundColor = '#4ade80'; 
                } else {
                    els.roeProgress.style.left = '50%';
                    els.roeProgress.style.width = `${width}%`;
                    els.roeProgress.style.backgroundColor = '#f87171'; 
                }
            }
        }

        function drawChart() {
            if (!canvasRef) return;
            const ctx = canvasRef.getContext('2d');
            const rect = canvasRef.parentElement.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;
            
            if (canvasRef.width !== rect.width * dpr || canvasRef.height !== rect.height * dpr) {
                canvasRef.width = rect.width * dpr;
                canvasRef.height = rect.height * dpr;
                ctx.scale(dpr, dpr);
            }
            const width = rect.width;
            const height = rect.height;
            const { game } = appState;

            ctx.clearRect(0, 0, width, height);
            const bgGradient = ctx.createLinearGradient(0, 0, 0, height);
            bgGradient.addColorStop(0, '#0f172a');
            bgGradient.addColorStop(1, '#1e293b');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, width, height);

            const candles = game.candles;
            if (candles.length === 0) return;

            const allPrices = candles.flatMap(c => [c.high, c.low]);
            if (game.position) allPrices.push(game.position.entryPrice, game.position.liqPrice);
            
            let minPrice = Math.min(...allPrices);
            let maxPrice = Math.max(...allPrices);
            const range = (maxPrice - minPrice) || 1;
            minPrice -= range * 0.15;
            maxPrice += range * 0.15;

            const getY = (p) => height - ((p - minPrice) / (maxPrice - minPrice)) * height;
            const candleWidth = Math.max((width / Math.max(candles.length, 10)) * 0.6, 2);
            const spacing = (width / Math.max(candles.length, 10)) - candleWidth;

            // Grid
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            for(let i=0; i<=4; i++) {
                const y = height * (0.1 + i * 0.2);
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                const priceLabel = maxPrice - (maxPrice - minPrice) * (y / height);
                ctx.fillStyle = '#64748b';
                ctx.font = '10px Inter, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(priceLabel.toFixed(getPricePrecision(game.selectedCoin.id)), width - 6, y - 4);
            }
            ctx.stroke();

            // Position Lines
            if (game.position) {
                const entryY = getY(game.position.entryPrice);
                ctx.beginPath();
                ctx.setLineDash([4, 4]);
                ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 1;
                ctx.moveTo(0, entryY); ctx.lineTo(width, entryY); ctx.stroke();
                ctx.fillStyle = '#fbbf24'; ctx.textAlign = 'left'; ctx.font = 'bold 10px Inter';
                ctx.fillText('Entry', 6, entryY - 6);

                const liqY = getY(game.position.liqPrice);
                ctx.beginPath();
                ctx.setLineDash([2, 2]);
                ctx.strokeStyle = '#ef4444';
                ctx.moveTo(0, liqY); ctx.lineTo(width, liqY); ctx.stroke();
                ctx.fillStyle = '#ef4444'; ctx.fillText('Liq. Price', 6, liqY - 6);
            }
            ctx.setLineDash([]);

            // Candles
            candles.forEach((c, i) => {
                const x = width - (candles.length - i) * (candleWidth + spacing) + spacing;
                const yO = getY(c.open); const yC = getY(c.close);
                const yH = getY(c.high); const yL = getY(c.low);
                const isGreen = c.close >= c.open;
                const color = isGreen ? '#34d399' : '#f87171';
                
                ctx.fillStyle = color; 
                ctx.strokeStyle = color; 
                ctx.lineWidth = 1;
                
                ctx.beginPath(); ctx.moveTo(x + candleWidth/2, yH); ctx.lineTo(x + candleWidth/2, yL); ctx.stroke();
                
                const bodyHeight = Math.max(Math.abs(yC - yO), 1);
                const bodyY = Math.min(yO, yC);
                ctx.fillRect(x, bodyY, candleWidth, bodyHeight);

                if (i === candles.length - 1) {
                    ctx.shadowColor = color;
                    ctx.shadowBlur = 10;
                    ctx.fillRect(x, bodyY, candleWidth, bodyHeight);
                    ctx.shadowBlur = 0;
                }
            });

            // Current Price Line
            const curY = getY(game.currentPrice);
            ctx.setLineDash([4, 4]);
            ctx.strokeStyle = '#94a3b8';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(0, curY); ctx.lineTo(width, curY); ctx.stroke();
            ctx.setLineDash([]);
        }

        function renderTradingGame() {
            const { game } = appState;
            const pricePrecision = getPricePrecision(game.selectedCoin.id);
            const floatingPnL = calculateFloatingPnL();
            const view = createElement('div', 'h-full flex flex-col bg-slate-900');

            // Header
            const header = createElement('div', 'px-3 py-2 bg-slate-800 shadow-md z-20 border-b border-slate-700/50');
            const coinSelector = createElement('div', 'grid grid-cols-4 gap-2 w-full');
            const coinColors = {
                'BTC': { active: 'bg-orange-500 text-white shadow-[0_0_15px_rgba(249,115,22,0.6)] ring-1 ring-orange-300', inactive: 'bg-slate-700 text-orange-500 hover:bg-slate-600' },
                'ETH': { active: 'bg-cyan-500 text-slate-900 shadow-[0_0_15px_rgba(6,182,212,0.6)] ring-1 ring-cyan-300', inactive: 'bg-slate-700 text-cyan-400 hover:bg-slate-600' },
                'SOL': { active: 'bg-purple-600 text-white shadow-[0_0_15px_rgba(147,51,234,0.6)] ring-1 ring-purple-300', inactive: 'bg-slate-700 text-purple-400 hover:bg-slate-600' },
                'DOGE': { active: 'bg-yellow-400 text-black shadow-[0_0_15px_rgba(250,204,21,0.6)] ring-1 ring-yellow-200', inactive: 'bg-slate-700 text-yellow-400 hover:bg-slate-600' }
            };

            COINS.forEach(c => {
                const isActive = game.selectedCoin.id === c.id;
                const styles = coinColors[c.id] || { active: 'bg-cyan-500', inactive: 'bg-slate-700' };
                const btnClass = `py-1.5 rounded-lg text-[11px] font-bold transition-all transform duration-200 ${isActive ? styles.active + ' scale-105' : styles.inactive}`;
                const btn = createElement('button', btnClass, c.id);
                btn.onclick = () => {
                    if (game.position) showToast("æŒå€‰ä¸­ä¸èƒ½æ›å¹£å–µï¼");
                    else {
                        setNestedState('game', { selectedCoin: c, isInitialized: false });
                        startGameLoop();
                    }
                };
                coinSelector.appendChild(btn);
            });
            header.appendChild(coinSelector);

            // Chart
            const chartArea = createElement('div', 'flex-1 relative bg-slate-900 w-full overflow-hidden');
            const basePrice = game.selectedCoin.price;
            const dailyChange = ((game.currentPrice - basePrice) / basePrice) * 100;
            const dailyChangeText = (dailyChange >= 0 ? '+' : '') + dailyChange.toFixed(2) + '%';
            const dailyChangeColor = dailyChange >= 0 ? 'text-green-400' : 'text-red-400';
            const priceColorClass = game.lastPriceDirection === 'up' ? 'text-green-400' : 'text-red-400';

            // Make the box draggable and reduce padding (py-2 -> py-0.5)
            const priceDisplay = createElement('div', `absolute top-4 left-4 z-10 bg-slate-900/80 px-3 py-0.5 rounded-xl backdrop-blur-md border border-slate-700/50 cursor-move select-none touch-none shadow-lg`, null, { id: 'game-price-wrapper' });
            priceDisplay.innerHTML = `
                <div class="flex flex-col">
                    <div class="flex items-baseline gap-2">
                        <h2 class="text-3xl font-mono font-bold text-white tracking-tighter"><span id="game-price-value">${game.currentPrice.toFixed(pricePrecision)}</span></h2>
                        <span id="game-price-label" class="text-xs font-sans font-bold opacity-80 text-slate-400">USDT</span>
                    </div>
                    <span id="game-price-change" class="text-xs font-mono font-bold ${dailyChangeColor}">${dailyChangeText}</span>
                </div>
            `;
            canvasRef = createElement('canvas', 'w-full h-full block', null, { style: 'touch-action: none;' });
            chartArea.append(priceDisplay, canvasRef);

            // Enable Dragging
            makeDraggable(priceDisplay, chartArea);

            // Dashboard
            // Reduced padding p-5 -> p-3, mb-6 -> mb-3, text sizes
            // Increased pb to 36 (9rem) to allow scrolling past the floating nav
            const dashboard = createElement('div', 'bg-slate-800 p-3 rounded-t-3xl border-t border-slate-700 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.5)] pb-36 overflow-y-auto custom-scroll z-20 relative -mt-4');
            const totalEquity = (game.balance + (game.position ? floatingPnL : 0) + (game.position ? game.position.margin : 0)).toFixed(2);
            const pnlColorClass = floatingPnL > 0 ? 'text-green-400' : floatingPnL < 0 ? 'text-red-400' : 'text-slate-200';
            
            dashboard.innerHTML += `
                <div class="flex justify-between mb-3 bg-slate-900/80 p-2 px-3 rounded-xl border border-slate-700 backdrop-blur-sm">
                    <div class="flex flex-col justify-center"><p class="text-[9px] text-slate-400 uppercase tracking-wider mb-0.5">å¯ç”¨é¤˜é¡</p><p id="game-balance" class="text-base font-bold text-white font-mono">${game.balance.toFixed(2)}</p></div>
                    <div class="w-px bg-slate-700 mx-1"></div>
                    <div class="flex flex-col justify-center"><p class="text-[9px] text-slate-400 uppercase tracking-wider mb-0.5">ç¸½æ¬Šç›Š</p><p id="game-equity" class="text-base font-bold text-white font-mono">${totalEquity}</p></div>
                    <div class="w-px bg-slate-700 mx-1"></div>
                    <div class="text-right flex flex-col justify-center"><p class="text-[9px] text-slate-400 uppercase tracking-wider mb-0.5">æœªå¯¦ç¾æç›Š</p><p id="game-pnl" class="text-base font-bold font-mono ${pnlColorClass}">${game.position ? (floatingPnL > 0 ? '+' : '') + floatingPnL.toFixed(2) : '--'}</p></div>
                </div>
            `;

            if (!game.position) {
                const inputsContainer = createElement('div', 'mb-2 animate-fade-in');
                // Custom Slider HTML
                inputsContainer.innerHTML = `
                    <div class="mb-4 slider-wrapper">
                        <div class="flex justify-between text-[10px] text-slate-400 mb-2 items-end">
                            <span class="flex items-center gap-1">${Icon('Lock', 10, 'text-slate-500')} æ§“æ¡¿å€æ•¸ (é•·æŒ‰è§£é–)</span>
                            <span class="text-cyan-400 font-bold text-sm font-mono slider-label">${game.leverage}x</span>
                        </div>
                        <div class="relative h-8 flex items-center select-none touch-none px-2 slider-container">
                             <div class="absolute w-full h-1.5 bg-slate-700 rounded-full left-0 right-0"></div> <!-- Track -->
                             <div class="absolute h-1.5 bg-cyan-500 rounded-full left-0 fill" style="width: 0%"></div> <!-- Fill -->
                             <div class="absolute w-6 h-6 bg-cyan-400 rounded-full shadow-[0_0_10px_rgba(34,211,238,0.5)] border-2 border-slate-800 transform -translate-x-1/2 flex items-center justify-center transition-transform z-10 thumb" style="left: 0%">
                                 <div class="w-0.5 h-2.5 bg-slate-900/30 mx-0.5 rounded-full"></div>
                                 <div class="w-0.5 h-2.5 bg-slate-900/30 mx-0.5 rounded-full"></div>
                             </div>
                        </div>
                        <div class="flex justify-between text-[9px] text-slate-500 mt-1 px-1 font-mono select-none">${LEVERAGE_OPTIONS.map(l => `<span>${l}x</span>`).join('')}</div>
                    </div>
                    <div class="mb-2">
                        <div class="text-[10px] text-slate-400 mb-1">æŠ•å…¥æœ¬é‡‘æ¯”ä¾‹ (Margin)</div>
                        <div class="grid grid-cols-4 gap-2">
                            ${MARGIN_PERCENT_OPTIONS.map(p => `<button class="margin-btn py-1.5 rounded-lg border text-[10px] font-bold transition-all duration-200 ${game.marginPercent === p ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400 shadow-sm' : 'bg-slate-700 border-transparent text-slate-400 hover:bg-slate-600'}" data-value="${p}">${p === 1 ? 'All In' : (p * 100) + '%'}</button>`).join('')}
                        </div>
                    </div>
                `;
                
                inputsContainer.querySelectorAll('.margin-btn').forEach(btn => btn.onclick = () => setNestedState('game', { marginPercent: parseFloat(btn.dataset.value) }));
                dashboard.appendChild(inputsContainer);

                // Reduce button height (py-4 -> py-3) and font size
                const actionArea = createElement('div', 'grid grid-cols-2 gap-3 mt-1');
                const longBtn = createElement('button', 'bg-gradient-to-b from-green-500 to-green-600 hover:from-green-400 hover:to-green-500 text-white font-bold py-3 rounded-xl active:scale-[0.98] transition-transform shadow-lg shadow-green-500/20', `<span class="text-base block">åšå¤š Buy</span><span class="text-[9px] opacity-80 font-normal tracking-wider">çœ‹æ¼² ${game.leverage}x</span>`);
                longBtn.onclick = () => handleTrade('long');
                const shortBtn = createElement('button', 'bg-gradient-to-b from-red-500 to-red-600 hover:from-red-400 hover:to-red-500 text-white font-bold py-3 rounded-xl active:scale-[0.98] transition-transform shadow-lg shadow-red-500/20', `<span class="text-base block">åšç©º Sell</span><span class="text-[9px] opacity-80 font-normal tracking-wider">çœ‹è·Œ ${game.leverage}x</span>`);
                shortBtn.onclick = () => handleTrade('short');
                actionArea.append(longBtn, shortBtn);
                dashboard.appendChild(actionArea);

                // Initialize Custom Slider SAFE MODE
                // Find the specific slider container inside the just-appended inputsContainer
                const sliderContainer = inputsContainer.querySelector('.slider-container');
                if (sliderContainer) {
                    initLongPressSlider(sliderContainer, LEVERAGE_OPTIONS.indexOf(game.leverage), LEVERAGE_OPTIONS, (val) => {
                        appState.game.leverage = val;
                        longBtn.innerHTML = `<span class="text-base block">åšå¤š Buy</span><span class="text-[9px] opacity-80 font-normal tracking-wider">çœ‹æ¼² ${val}x</span>`;
                        shortBtn.innerHTML = `<span class="text-base block">åšç©º Sell</span><span class="text-[9px] opacity-80 font-normal tracking-wider">çœ‹è·Œ ${val}x</span>`;
                    });
                }

            } else {
                const typeColor = game.position.type === 'long' ? 'text-green-400' : 'text-red-400';
                const typeBg = game.position.type === 'long' ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30';
                const info = createElement('div', `mb-2 text-xs text-slate-300 ${typeBg} p-3 rounded-xl border backdrop-blur-sm`, `
                    <div class="flex justify-between items-center mb-2 pb-2 border-b border-slate-700/50">
                        <span class="font-black ${typeColor} text-lg flex items-center gap-2 tracking-tight">${game.position.type === 'long' ? 'åšå¤š LONG' : 'åšç©º SHORT'} <span class="text-[10px] bg-slate-800 px-1.5 py-0.5 rounded text-slate-300 font-normal">${game.leverage}x</span></span>
                        <div class="text-right">
                            <span class="text-[9px] text-slate-400 block">é–‹å€‰åƒ¹æ ¼</span>
                            <span class="font-mono text-slate-200">${game.position.entryPrice.toFixed(pricePrecision)}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="flex justify-between text-[10px] mb-1"><span>ROE (æ¬Šç›Šå ±é…¬ç‡)</span><span id="game-roe" class="font-bold text-slate-200 font-mono">--%</span></div>
                        <div class="relative w-full bg-slate-900 h-2 rounded-full overflow-hidden shadow-inner">
                            <div class="absolute left-1/2 top-0 bottom-0 w-0.5 bg-slate-600 -translate-x-1/2 z-10"></div>
                            <div id="game-roe-progress" class="absolute top-0 bottom-0 transition-all duration-300 rounded-full"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-[10px] mt-1">
                        <div class="bg-slate-900/50 p-1.5 rounded-lg">
                            <span class="text-slate-500 block mb-0.5">ä¿è­‰é‡‘</span>
                            <span class="font-mono text-slate-200">${game.position.margin.toFixed(2)}</span>
                        </div>
                        <div class="bg-slate-900/50 p-1.5 rounded-lg border border-red-500/20">
                            <span class="text-red-400 block mb-0.5 flex items-center gap-1">${Icon('AlertTriangle', 8)} å¼·å¹³åƒ¹æ ¼</span>
                            <span class="font-mono text-red-200">${game.position.liqPrice.toFixed(pricePrecision)}</span>
                        </div>
                    </div>
                `);
                const closeBtn = createElement('button', 'w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-2.5 rounded-xl active:scale-[0.98] transition-all border border-slate-600 shadow-lg', 'å¹³å€‰ (ç²åˆ©äº†çµ / æ­¢æ) å–µï¼');
                closeBtn.onclick = closePosition;
                dashboard.appendChild(info);
                dashboard.appendChild(closeBtn);
            }

            view.append(header, chartArea, dashboard);
            if (!game.intervalId) {
                startGameLoop();
                window.addEventListener('resize', drawChart);
            } else {
                // Slight delay to ensure DOM is ready for canvas sizing
                setTimeout(drawChart, 0);
            }
            return view;
        }

        // --- Main Render ---
        function renderApp() {
            APP_ROOT.innerHTML = ''; 
            const contentArea = createElement('div', 'flex-1 overflow-hidden relative z-0 bg-slate-900');
            if (appState.activeTab === 'learn') contentArea.appendChild(renderLearnView());
            else if (appState.activeTab === 'game') contentArea.appendChild(renderTradingGame());
            else if (appState.activeTab === 'about') contentArea.appendChild(renderAboutView());

            // --- NAVIGATION BAR WITH EXTENDED SAFE AREA ---
            const navBar = createElement('div', 'h-auto pb-safe-extended pt-2 bg-slate-900/95 backdrop-blur-lg border-t border-slate-800 grid grid-cols-3 fixed bottom-0 w-full z-[50]');
            
            const createNavBtn = (id, label, icon) => {
                const isActive = appState.activeTab === id;
                const btn = createElement('button', `flex flex-col items-center justify-center gap-1 transition-colors relative group ${isActive ? 'text-cyan-400' : 'text-slate-500 hover:text-slate-300'}`);
                btn.onclick = () => {
                    if (appState.activeTab === 'game' && id !== 'game') {
                        clearInterval(appState.game.intervalId);
                        appState.game.intervalId = null;
                        window.removeEventListener('resize', drawChart);
                    }
                    setState({ activeTab: id });
                };
                
                btn.innerHTML = `
                    <div class="p-1 rounded-xl transition-all duration-300 ${isActive ? 'bg-cyan-500/10 scale-110' : ''}">
                        ${Icon(icon, 24)}
                    </div>
                    <span class="text-[10px] font-medium tracking-wide mb-1">${label}</span>
                `;
                return btn;
            };

            navBar.append(createNavBtn('learn', 'å­¸ç¿’', 'BookOpen'), createNavBtn('game', 'æ¨¡æ“¬äº¤æ˜“', 'Gamepad2'), createNavBtn('about', 'é—œæ–¼', 'Info'));
            APP_ROOT.append(contentArea, navBar);

            if (appState.toastMsg) {
                const t = renderToast();
                if (t) APP_ROOT.insertAdjacentHTML('afterbegin', t);
            }

            if (appState.activeTab === 'game') drawChart();
        }

        window.onload = () => {
            renderApp();
            startGameLoop();
        };
    </script>
</body>
</html>
